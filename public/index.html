<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>FL6_INGAME_HUD</title>
	<link rel="stylesheet" href="style.css">
</head>
<body>
	<!-- TOP PART -->
	<div class="top">
		<div class="top-section-left">
			<div class="tournament-bar">
				Falcon League 6 &ndash; Grupa A
			</div>
			<div class="radar">
				<img src="https://blitz-cdn-plain.blitz.gg/blitz/cs2/maps/de_mirage.svg" alt="FL6_RADAR_OVERVIEW" class="radar-img">
			</div>
		</div>
		<div class="middle-bar-wrapper">
			<div class="middle-bar">
				<div class="team team-left" id="team-left-name">
					CT
				</div>
				<div class="score">
					<div class="team-score" id="team-left-score">
						0
					</div>
					<div class="series-points">
						<div class="series-square"></div>
						<div class="series-square"></div>
					</div>
				</div>
				<div class="middle-bar-mid">
					<div class="round-counter">Runda 1/24</div>
					<div class="round-timer">--:--</div>
				</div>
				<div class="score">
					<div class="series-points">
						<div class="series-square"></div>
						<div class="series-square"></div>
					</div>
					<div class="team-score" id="team-right-score">
						0
					</div>
				</div>
				<div class="team team-right" id="team-right-name">
					T
				</div>
			</div>

			<div class="middle-bar-countdowns">
				<div class="countdown-wrapper">
					<div class="middle-bar-defuse">
						Nudlez is defusing
					</div>
				</div>
				<div class="countdown-wrapper">
					<div class="middle-bar-bombplant">
						Sajowski is&nbsp;planting&nbsp;the&nbsp;bomb
					</div>
				</div>
				<!-- <div class="middle-bar-bomb">
					Bomb planted
				</div> -->
			</div>
		</div>

		<!-- if 1vX situation: switch to "CLUTCH: 1vX", else sponsor img -->
		<div class="top-section-right">
			<div class="sponsor-clutch">
				<img src="https://cdn.brandfetch.io/idTGhLyv09/theme/light/logo.svg?c=1bxid64Mup7aczewSAYMX&t=1668070452856" alt="FL6_SPONSOR_IMAGE" class="sponsor-img">
				<!-- <div class="clutch-title">
					CLUTCH
				</div>
				<div class="clutch-versus">
					1 vs 4
				</div> -->
			</div>
		</div>
	</div>

	<!-- MIDDLE PART -->
	<!-- <div class="middle">
		<div class="production">
			<div class="production-title">
				Produkcja
			</div>
			<div class="production-content">
				toaster
			</div>
			<div class="production-title">
				Komentatorzy
			</div>
			<div class="production-content">
				Magzik<br>
				Pitek
			</div>
		</div>
	</div> -->

	<!-- BOTTOM PART -->
	<div class="bottom">
		<div class="team-bottom" id="team-left"></div>

		<div class="current-player" id="current-player"></div>

		<div class="team-bottom" id="team-right"></div>
	</div>

	<script>
		const ws = new WebSocket(`ws://${location.host}`);
		let last_winner = null;
		let last_phase_start = null;
		let remaining_time = 0;
		let round_phase = null;

		ws.onmessage = e => {
			const s = JSON.parse(e.data);
			const ps = Object.values(s.allplayers || {});
			const obs = ps.find(p => p.observer_slot == s.player?.observer_slot);
			const t_L = ps.filter(p => p.team === 'CT');
			const t_R = ps.filter(p => p.team === 'T');
			// const t_L = ps.filter(p => p.team === 'CT' && (!obs || p.observer_slot !== obs.observer_slot));
			// const t_R = ps.filter(p => p.team === 'T' && (!obs || p.observer_slot !== obs.observer_slot));

			document.getElementsByClassName('radar')[0].innerHTML = `
			<img src="./radars/ingame/${s.map.name}.png" alt="FL6_RADAR_OVERVIEW" class="radar-img">
			`;

			['team-left', 'team-right'].forEach(id => {
				document.getElementById(id).innerHTML = (id === 'team-left' ? t_L : t_R)
					.map(p => render_player(p, p.observer_slot === obs?.observer_slot))
					.join('');
			});
			document.getElementById('current-player').innerHTML = render_current(obs);

			document.getElementById('team-left-name').textContent = s.map?.team_ct?.name || 'CT';
			document.getElementById('team-right-name').textContent = s.map?.team_t?.name || 'T';
			document.getElementById('team-left-score').textContent = s.map?.team_ct?.score || 0;
			document.getElementById('team-right-score').textContent = s.map?.team_t?.score || 0;

			const rnd = (s.map?.round || 0) + 1;
			document.getElementsByClassName('round-counter')[0].textContent = `Runda ${rnd}/24`;

			// last_phase_start = (s.provider?.timestamp || Date.now() / 1000) * 1000;
			// round_phase = s.round?.phase || 'live';

			const new_phase = s.round?.phase || 'live';
			const new_time = parseFloat(s.phase_countdowns?.phase_ends_in || 0);
			const server_time = (s.provider?.timestamp || Date.now() / 1000) * 1000;
			// round_phase = s.phase_countdowns?.phase || s.round?.phase || 'live';
			// remaining_time = parseFloat(phase_ends_in || 0);
			if (new_phase !== round_phase || Math.abs(new_time - remaining_time) > 1)
			{
				round_phase = new_phase;
				remaining_time = new_time;
			}
			// if (round_phase === null || last_phase_start === null || new_phase !== round_phase)
			// {
			// 	if (phase_time === 0 && ['live', 'bomb', 'defuse'].includes(new_phase))
			// 	{
			// 		console.warn(`Skipping timer initialization: phase = '${new_phase}' and phase_time = 0`);
			// 		return;
			// 	}

			// 	round_phase = new_phase;
			// 	last_phase_time = phase_time;
			// 	last_phase_start = (server_time - phase_time);
			// 	console.log(`Phase initialized/changed to: ${round_phase} at ${new Date(last_phase_start).toISOString()} (phase_time = ${phase_time})`);
			// }
			// last_phase_time = s.round?.phase_time || 0;

			const alive_ct = t_L.filter(p => p.state.health > 0).length;
			const alive_t = t_R.filter(p => p.state.health > 0).length;
			
			if (s.round?.phase === 'over' && s.map?.team_ct?.score !== last_winner)
			{
				last_winner = s.map?.team_ct?.score;
			}
		};

		function render_player(p, is_spectated = false)
		{
			const dead = p.state.health <= 0;
			const spec = is_spectated ? 'player-card-spectated' : '';
			const w = p.state.weapon?.name || '';
			// const icon = w.includes
			return `
			<div class="player-card ${dead ? 'player-card-dead' : ''} ${spec}">
				<div class="player-name">
					<div class="name">${p.name}</div>
					${p.state.round_kills > 0 ? `<div class="roundkills">${p.state.round_kills}</div>` : ``}
				</div>
				<div class="player-health ${p.team === 'CT' ? 'player-ct' : 'player-t'}">
					<div class="health">
						<img src="./icons/health.svg" alt="FL6_PLAYER_HEALTH" class="icon">
						<div class="content">${p.state.health}</div>
					</div>
					<div class="armor">
						<img src="${p.state.helmet ? './icons/armor-helmet.svg' : './icons/armor.svg'}" alt="FL6_PLAYER_ARMOR" class="icon">
						<div class="content">${p.state.armor}</div>
					</div>
				</div>
				<div class="player-stats">
					<div class="kills">
						<div class="icon">K</div>
						<div class="content">${p.match_stats.kills}</div>
					</div>
					<div class="deaths">
						<div class="icon">D</div>
						<div class="content">${p.match_stats.deaths}</div>
					</div>
					<div class="money">
						<div class="content">$${p.state.money}</div>
					</div>
				</div>
				<div class="player-weapons">
					<img src="https://raw.githubusercontent.com/drweissbrot/cs-hud/56870aee627ae2d247fa36abd308795c4e6e1e02/src/themes/fennec/img/weapons/ak47.svg" alt="FL6_PLAYER_GUN" class="player-weapon-gun">
					<div class="grenades">
						<img src="https://raw.githubusercontent.com/drweissbrot/cs-hud/56870aee627ae2d247fa36abd308795c4e6e1e02/src/themes/fennec/img/weapons/frag_grenade.svg" alt="FL6_PLAYER_GRENADE" class="player-weapon-gun">
						<img src="https://raw.githubusercontent.com/drweissbrot/cs-hud/56870aee627ae2d247fa36abd308795c4e6e1e02/src/themes/fennec/img/weapons/flashbang.svg" alt="FL6_PLAYER_GRENADE" class="player-weapon-gun">
						<img src="https://raw.githubusercontent.com/drweissbrot/cs-hud/56870aee627ae2d247fa36abd308795c4e6e1e02/src/themes/fennec/img/weapons/smokegrenade.svg" alt="FL6_PLAYER_GRENADE" class="player-weapon-gun">
						<img src="https://raw.githubusercontent.com/drweissbrot/cs-hud/56870aee627ae2d247fa36abd308795c4e6e1e02/src/themes/fennec/img/weapons/firebomb.svg" alt="FL6_PLAYER_GRENADE" class="player-weapon-gun">
					</div>
				</div>
			</div>
			`;
		}

		function render_current(p)
		{
			if (!p) return '';

			const weapons = Object.values(p.weapons || {});
			const active_weapon = weapons.find(w => w.state === 'active');
			const ammo_clip = active_weapon?.ammo_clip ?? 0;
			const ammo_reserve = active_weapon?.ammo_reserve ?? 0;

			return `
			<div class="player-name">
				<div class="name">${p.name}</div>
			</div>
			<div class="player-stats ${p.team === 'CT' ? 'player-ct' : 'player-t'}">
				<div class="player-ammo">
					<img src="https://raw.githubusercontent.com/drweissbrot/cs-hud/56870aee627ae2d247fa36abd308795c4e6e1e02/src/themes/fennec/img/weapons/ammobox_threepack.svg" alt="FL6_AMMO_ICON" class="icon">
					<div class="content">
					${ammo_clip}/${ammo_reserve}
					</div>
				</div>
				<div class="player-health">
					<div class="health">
						<img src="./icons/health.svg" alt="FL6_PLAYER_HEALTH" class="icon">
						<div class="content">${p.state.health}</div>
					</div>
					<div class="armor">
						<img src="${p.state.helmet ? './icons/armor-helmet.svg' : './icons/armor.svg'}" alt="FL6_PLAYER_ARMOR" class="icon">
						<div class="content">${p.state.armor}</div>
					</div>
				</div>
			</div>
			`;
		}

		function format_time(sec)
		{
			const s = Math.max(Math.floor(sec), 0);
			const m = Math.floor(s / 60), r = s % 60;
			return `${m}:${r.toString().padStart(2, '0')}`;
		}

		setInterval(() => {
			if (!isNaN(remaining_time))
			{
				remaining_time = Math.max(0, remaining_time - 0.5);
				const text = format_time(remaining_time);
				const timer = document.getElementsByClassName('round-timer')[0];
				if (timer) timer.textContent = text;
			}
		}, 500);
	</script>
</body>
</html>